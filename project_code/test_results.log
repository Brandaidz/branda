
> branda-backend@1.0.0 test
> node --experimental-vm-modules node_modules/jest/bin/jest.js --config jest.config.json __tests__/controllers/authController.test.js

(node:4118) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:4118) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/register[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors de l'inscription: newUser.save is not a function[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/register[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/login[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors de la connexion: User.findOne(...).select is not a function[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/login[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors de la connexion: User.findOne(...).select is not a function[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: GET /api/auth/verify-email/invalid-token[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors de la v√©rification de l'email: Invalid token or secret[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: GET /api/auth/verify-email/valid-verification-token[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors de la v√©rification de l'email: Invalid token or secret[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: GET /api/auth/verify-email/valid-verification-token[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors de la v√©rification de l'email: Invalid token or secret[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/refresh-token[39m
2025-05-02 08:12:36:1236 [31merror[39m: [31mErreur lors du rafra√Æchissement du token: verify is not defined[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/forgot-password[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mReset token pour test@example.com: valid-reset-token[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mReset URL: http://localhost:3000/reset-password/valid-reset-token[39m
2025-05-02 08:12:36:1236 [32minfo[39m: [32mAcc√®s √† la route auth: POST /api/auth/logout[39m
FAIL __tests__/controllers/authController.test.js
  Auth Controller
    POST /api/auth/register
      ‚úï should register a new user and send verification email (103 ms)
      ‚úì should return 409 if user already exists (10 ms)
    POST /api/auth/login
      ‚úï should login verified user and return tokens (10 ms)
      ‚úï should return 403 if email not verified (7 ms)
    GET /api/auth/verify-email/:token
      ‚úï should verify email with a valid token
      ‚úï should return 400 if token is invalid (9 ms)
      ‚úï should return 404 if user not found (6 ms)
      ‚úï should return 400 if email already verified (6 ms)
    POST /api/auth/refresh-token
      ‚úï should issue a new access token with valid refresh token (5 ms)
    POST /api/auth/forgot-password
      ‚úì should send password reset email if user exists (10 ms)
    POST /api/auth/reset-password/:token
      ‚úï should reset password with a valid token
    POST /api/auth/logout
      ‚úï should logout user and clear refresh token (5 ms)

  ‚óè Auth Controller ‚Ä∫ POST /api/auth/register ‚Ä∫ should register a new user and send verification email

    expect(received).toEqual(expected) // deep equality

    Expected: 201
    Received: 500

      265 |         .send({ email: "newuser@example.com", password: "Password123!", name: "New User" });
      266 |
    > 267 |       expect(res.statusCode).toEqual(201);
          |                              ^
      268 |       expect(res.body).toHaveProperty("message", "Inscription r√©ussie. Veuillez v√©rifier votre email pour activer votre compte.");
      269 |       expect(mockedUserCreate).toHaveBeenCalledWith(expect.objectContaining({ email: "newuser@example.com" }));
      270 |       expect(mockedBcryptHash).toHaveBeenCalledWith("Password123!", 10);

      at Object.<anonymous> (__tests__/controllers/authController.test.js:267:30)

  ‚óè Auth Controller ‚Ä∫ POST /api/auth/login ‚Ä∫ should login verified user and return tokens

    expect(received).toEqual(expected) // deep equality

    Expected: 200
    Received: 500

      302 |         .send({ email: "test@example.com", password: "Password123!" });
      303 |
    > 304 |       expect(res.statusCode).toEqual(200);
          |                              ^
      305 |       expect(res.body).toHaveProperty("token", "mock-access-token");
      306 |       expect(res.body).toHaveProperty("user");
      307 |       expect(res.body.user).not.toHaveProperty("passwordHash");

      at Object.<anonymous> (__tests__/controllers/authController.test.js:304:30)

  ‚óè Auth Controller ‚Ä∫ POST /api/auth/login ‚Ä∫ should return 403 if email not verified

    expect(received).toEqual(expected) // deep equality

    Expected: 403
    Received: 500

      320 |         .send({ email: "test@example.com", password: "Password123!" });
      321 |       
    > 322 |       expect(res.statusCode).toEqual(403);
          |                              ^
      323 |       expect(res.body).toHaveProperty("message", "Veuillez v√©rifier votre adresse email avant de vous connecter.");
      324 |     });
      325 |     

      at Object.<anonymous> (__tests__/controllers/authController.test.js:322:30)

  ‚óè Auth Controller ‚Ä∫ GET /api/auth/verify-email/:token ‚Ä∫ should verify email with a valid token

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      332 |       mockedUserFindById.mockResolvedValue(mockUnverifiedUser); // User found via token, initially unverified
      333 |       // jwt.verify mock handles 'valid-verification-token' in beforeEach
    > 334 |       mockUnverifiedUser.save.mockResolvedValue({ ...mockUnverifiedUser, isEmailVerified: true }); // Mock save to return verified user
          |                               ^
      335 |
      336 |       const res = await request(app)
      337 |         .get("/api/auth/verify-email/valid-verification-token")

      at Object.<anonymous> (__tests__/controllers/authController.test.js:334:31)

  ‚óè Auth Controller ‚Ä∫ GET /api/auth/verify-email/:token ‚Ä∫ should return 400 if token is invalid

    expect(received).toEqual(expected) // deep equality

    Expected: 400
    Received: 500

      356 |        });
      357 |        const res = await request(app).get("/api/auth/verify-email/invalid-token").send();
    > 358 |        expect(res.statusCode).toEqual(400);
          |                               ^
      359 |        expect(res.body).toHaveProperty("message", "Token de v√©rification invalide ou expir√©.");
      360 |     });
      361 |

      at Object.<anonymous> (__tests__/controllers/authController.test.js:358:31)

  ‚óè Auth Controller ‚Ä∫ GET /api/auth/verify-email/:token ‚Ä∫ should return 404 if user not found

    expect(received).toEqual(expected) // deep equality

    Expected: 404
    Received: 500

      364 |       mockedUserFindById.mockResolvedValue(null); // User not found
      365 |       const res = await request(app).get("/api/auth/verify-email/valid-verification-token").send();
    > 366 |       expect(res.statusCode).toEqual(404);
          |                              ^
      367 |       expect(res.body).toHaveProperty("message", "Utilisateur non trouv√©.");
      368 |     });
      369 |

      at Object.<anonymous> (__tests__/controllers/authController.test.js:366:30)

  ‚óè Auth Controller ‚Ä∫ GET /api/auth/verify-email/:token ‚Ä∫ should return 400 if email already verified

    expect(received).toEqual(expected) // deep equality

    Expected: 400
    Received: 500

      371 |       mockedUserFindById.mockResolvedValue(mockUser); // User found, already verified
      372 |       const res = await request(app).get("/api/auth/verify-email/valid-verification-token").send();
    > 373 |       expect(res.statusCode).toEqual(400);
          |                              ^
      374 |       expect(res.body).toHaveProperty("message", "L\'email est d√©j√† v√©rifi√©.");
      375 |     }); // Closing brace for the 'it' block
      376 |   }); // Closing brace for the 'describe' block

      at Object.<anonymous> (__tests__/controllers/authController.test.js:373:30)

  ‚óè Auth Controller ‚Ä∫ POST /api/auth/refresh-token ‚Ä∫ should issue a new access token with valid refresh token

    expect(received).toEqual(expected) // deep equality

    Expected: 200
    Received: 500

      388 |         .send();
      389 |
    > 390 |       expect(res.statusCode).toEqual(200);
          |                              ^
      391 |       expect(res.body).toHaveProperty("token", "mock-access-token");
      392 |       expect(mockedJwtVerify).toHaveBeenCalledWith("valid-refresh-token", process.env.JWT_REFRESH_SECRET);
      393 |       expect(mockedGetRefreshToken).toHaveBeenCalledWith(mockUser._id); // Controller gets jti from Redis using userId from verified token

      at Object.<anonymous> (__tests__/controllers/authController.test.js:390:30)

  ‚óè Auth Controller ‚Ä∫ POST /api/auth/reset-password/:token ‚Ä∫ should reset password with a valid token

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      426 |         mockedUserFindById.mockResolvedValue(mockUser);
      427 |         // jwt.verify mock handles 'valid-reset-token' in beforeEach
    > 428 |         mockUser.save.mockResolvedValue(true);
          |                       ^
      429 |
      430 |         const res = await request(app)
      431 |             .post("/api/auth/reset-password/valid-reset-token")

      at Object.<anonymous> (__tests__/controllers/authController.test.js:428:23)

  ‚óè Auth Controller ‚Ä∫ POST /api/auth/logout ‚Ä∫ should logout user and clear refresh token

    expect(received).toEqual(expected) // deep equality

    Expected: 200
    Received: 401

      467 |         .send(); // Body is not needed, but user ID comes from protect mock
      468 |
    > 469 |       expect(res.statusCode).toEqual(200);
          |                              ^
      470 |       expect(res.body).toHaveProperty("message", "D√©connexion r√©ussie.");
      471 |       // Check if the mock for protect was called (needs protect mock setup)
      472 |       // expect(mockedProtect).toHaveBeenCalled();

      at Object.<anonymous> (__tests__/controllers/authController.test.js:469:30)

------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------
File                          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                         
------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------
All files                     |    4.74 |     3.42 |    3.16 |    4.84 |                                                                                                                           
 backend                      |       0 |        0 |       0 |       0 |                                                                                                                           
  server.js                   |       0 |        0 |       0 |       0 | 3-172                                                                                                                     
 backend/config               |   17.79 |    19.04 |    8.69 |   17.79 |                                                                                                                           
  db.js                       |       0 |        0 |       0 |       0 | 7-25                                                                                                                      
  errorHandler.js             |       0 |        0 |       0 |       0 | 8-62                                                                                                                      
  logger.js                   |     100 |      100 |     100 |     100 |                                                                                                                           
  monitoring.js               |       0 |        0 |       0 |       0 | 2-90                                                                                                                      
  openai.js                   |       0 |      100 |     100 |       0 | 1-9                                                                                                                       
  redis.js                    |   21.56 |       50 |       0 |   21.56 | 12-14,21,25,29,33,38-42,47-54,59-63,68-72,78-84,90-100                                                                    
 backend/controllers          |     5.4 |     3.39 |    4.76 |    5.57 |                                                                                                                           
  accountingController.js     |       0 |        0 |       0 |       0 | 9-534                                                                                                                     
  authController.js           |   38.85 |       25 |   45.45 |   38.85 | 54,66-72,83,93-99,113-114,143-164,184,188-204,222,228-229,236-257,263-264,277-326,339,343-345,363-369,379-414,427-446,450 
  chatController.js           |       0 |        0 |       0 |       0 | 14-157                                                                                                                    
  employeeController.js       |       0 |        0 |       0 |       0 | 7-344                                                                                                                     
  onboardingController.js     |       0 |        0 |       0 |       0 | 8-166                                                                                                                     
  performanceController.js    |       0 |        0 |       0 |       0 | 8-376                                                                                                                     
  productController.js        |       0 |        0 |       0 |       0 | 7-245                                                                                                                     
  saleController.js           |       0 |        0 |       0 |       0 | 10-398                                                                                                                    
  scheduleController.js       |       0 |        0 |       0 |       0 | 8-383                                                                                                                     
  summaryController.js        |       0 |        0 |       0 |       0 | 10-94                                                                                                                     
 backend/middlewares          |    6.66 |      3.4 |    2.85 |     6.8 |                                                                                                                           
  authMiddleware.js           |   21.87 |    11.76 |   16.66 |   22.58 | 14-15,23-37,67-109,116-119,126-129,136-162                                                                                
  corsMiddleware.js           |       0 |        0 |       0 |       0 | 6-72                                                                                                                      
  errorHandler.js             |       0 |        0 |       0 |       0 | 8-63                                                                                                                      
  errorMiddleware.js          |       0 |        0 |       0 |       0 | 1-3                                                                                                                       
  metricsMiddleware.js        |       0 |        0 |       0 |       0 | 7-44                                                                                                                      
  prometheusAuthMiddleware.js |       0 |        0 |       0 |       0 | 9-34                                                                                                                      
  rateLimiter.js              |       0 |        0 |       0 |       0 | 8-48                                                                                                                      
  roleMiddleware.js           |       0 |        0 |       0 |       0 | 7-35                                                                                                                      
  roleTestMiddleware.js       |       0 |        0 |       0 |       0 | 9-34                                                                                                                      
  tenantMiddleware.js         |       0 |        0 |       0 |       0 | 9-22                                                                                                                      
  tenantPlugin.js             |       0 |        0 |       0 |       0 | 9-59                                                                                                                      
  tokenBlacklist.js           |    9.37 |        0 |       0 |    9.37 | 10-29,37-67                                                                                                               
 backend/models               |       0 |        0 |       0 |       0 |                                                                                                                           
  accountingEntryModel.js     |       0 |      100 |     100 |       0 | 4-66                                                                                                                      
  conversationModel.js        |       0 |      100 |     100 |       0 | 4-59                                                                                                                      
  conversationSummaryModel.js |       0 |      100 |     100 |       0 | 4-43                                                                                                                      
  employeeModel.js            |       0 |      100 |     100 |       0 | 4-62                                                                                                                      
  performanceModel.js         |       0 |      100 |     100 |       0 | 4-74                                                                                                                      
  productModel.js             |       0 |      100 |     100 |       0 | 4-50                                                                                                                      
  saleModel.js                |       0 |      100 |     100 |       0 | 4-78                                                                                                                      
  scheduleModel.js            |       0 |      100 |     100 |       0 | 4-71                                                                                                                      
  tenantModel.js              |       0 |      100 |     100 |       0 | 4-22                                                                                                                      
  userModel.js                |       0 |        0 |       0 |       0 | 5-75                                                                                                                      
 backend/routes               |    9.44 |    13.33 |    5.26 |    9.03 |                                                                                                                           
  accountingRoutes.js         |       0 |      100 |     100 |       0 | 16-31                                                                                                                     
  authRoutes.js               |   89.47 |    66.66 |     100 |     100 | 22-23                                                                                                                     
  chatRoutes.js               |       0 |      100 |     100 |       0 | 10-22                                                                                                                     
  employeeRoutes.js           |       0 |      100 |     100 |       0 | 16-33                                                                                                                     
  healthRoutes.js             |       0 |        0 |       0 |       0 | 7-160                                                                                                                     
  metricsRoutes.js            |       0 |      100 |       0 |       0 | 7-29                                                                                                                      
  onboardingRoutes.js         |       0 |      100 |     100 |       0 | 10-23                                                                                                                     
  performanceRoutes.js        |       0 |      100 |       0 |       0 | 15-43                                                                                                                     
  productRoutes.js            |       0 |      100 |       0 |       0 | 14-43                                                                                                                     
  saleRoutes.js               |       0 |      100 |       0 |       0 | 14-43                                                                                                                     
  scheduleRoutes.js           |       0 |      100 |       0 |       0 | 15-47                                                                                                                     
  summaryRoutes.js            |       0 |      100 |       0 |       0 | 10-27                                                                                                                     
 backend/services             |       0 |        0 |       0 |       0 |                                                                                                                           
  aiService.js                |       0 |        0 |       0 |       0 | 2-28                                                                                                                      
  contextManager.js           |       0 |        0 |       0 |       0 | 14-182                                                                                                                    
  contextService.js           |       0 |        0 |       0 |       0 | 4-22                                                                                                                      
  emailService.js             |       0 |        0 |       0 |       0 | 5-78                                                                                                                      
  memoryService.js            |       0 |        0 |       0 |       0 | 2-52                                                                                                                      
  metricsService.js           |       0 |        0 |       0 |       0 | 6-129                                                                                                                     
  openaiService.js            |       0 |        0 |       0 |       0 | 7-240                                                                                                                     
  orchestrator.js             |       0 |        0 |       0 |       0 | 22-116                                                                                                                    
  queue.js                    |       0 |        0 |       0 |       0 | 2-76                                                                                                                      
  queueService.js             |       0 |        0 |       0 |       0 | 7-240                                                                                                                     
  redisService.js             |       0 |        0 |       0 |       0 | 5-352                                                                                                                     
  summaryManager.js           |       0 |        0 |       0 |       0 | 13-205                                                                                                                    
------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (70%) not met: 4.74%
Jest: "global" coverage threshold for branches (70%) not met: 3.42%
Jest: "global" coverage threshold for lines (70%) not met: 4.84%
Jest: "global" coverage threshold for functions (70%) not met: 3.16%
Test Suites: 1 failed, 1 total
Tests:       10 failed, 2 passed, 12 total
Snapshots:   0 total
Time:        4.715 s
Ran all test suites matching /__tests__\/controllers\/authController.test.js/i.
